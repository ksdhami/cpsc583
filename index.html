<!DOCTYPE html>
<html>
    <title>24 Hours of Le Mans History</title>
    <head>
        <meta charset="utf-8"/>
        <link type="text/css" rel="stylesheet" href="style.css"/>
        <script type="text/javascript" src="https://d3js.org/d3.v5.js"></script>
    </head>
    <body>
        <h1>The 24 Hours of Le Mans</h1>
        <h2>The greatest endurance race in the world</h2>
        <div id="div_visuals" class="div_boxes"></div>

        <div id="wrapper">
            <div id="row">
                <div id="tooltip"></div>
                <div id="bar1" class="progress" data-barValue="">
                    <div id="helper_text1">Car Laps Completed vs Max Laps Completed (397 laps)<br><br></div>
                </div>
                <div id="bar2" class="progress" data-barValue="">
                    <div id="helper_text2">Car Average Speed vs Max Average Speed (225.228 kph)<br><br></div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            let _data;

            const maxAveSpeed = 225;
            const maxLaps = 396;
            const maxDistance = 5410.713;

            let lineClicked = false;

            let columns = ["Year", "Distance", "Fastest Speed", "Circuit Design", "Deaths"],
                color = d3.scaleOrdinal()
                    .domain(["CHENARD-WALCKER", "BENTLEY", "LORRAINE-DIETRICH", "ALFA-ROMEO", "LAGONDA", "BUGATTI", "DELAHAYE", "FERRARI", "TALBOT-LAGO", "JAGUAR", "MERCEDES-BENZ", "ASTON-MARTIN", "FORD", "PORSCHE", "MATRA-SIMCA", "GULF", "RENAULT-ALPINE", "RONDEAU", "SAUBER", "MAZDA", "PEUGEOT", "McLAREN", "BMW", "AUDI" ])
                    .range(["#2F74B5", "#183f46", "#3E62AB", "#8A1A20", "#ED6C73", "#3E91DF", "#0D2850", "#A72119", "#010101", "#1F4E47", "#ADADAD", "#56B3A1", "#7898D8", "#656565", "#71F28B", "#EC7A42", "#FADD4B", "#575757", "#B8B8B8", "#D0732B", "#184073", "#818181", "#B5B5B5", "#693241"]);

            let margin = {top: 20, right: 110, bottom: 20, left: 110},
                width = document.body.clientWidth - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;

            let xAxis = d3.scalePoint()
                    .domain(columns)
                    .range([0, width]),
                yAxis = {};

            let svg = d3.select("#div_visuals")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            let tooltip = d3.select("#tooltip")
                .attr("transform", "translate(" + margin.left + "," + height + ")")
                .style("opacity", 0)
                .style("color", "black");

            var parseTime = d3.timeParse("%Y");

            d3.csv("lemans4.csv").then(function(data) {
                _data = data;

                // https://bl.ocks.org/d3noob/0e276dc70bb9184727ee47d6dd06e915
                data.forEach(function(d) {
                    d.Year = parseTime(d.Year);
                });

                columns.forEach(function(d) {
                    console.log(d);

                    if (d === "Year") {
                        yAxis[d] = d3.scaleTime()
                            .domain(d3.extent(data, function(e) {
                                return e.Year;
                            }))
                            .range([height, 0]);
                    } else {
                        yAxis[d] = d3.scaleLinear()
                            .domain(d3.extent(data, function (e) {
                                return +e[d];
                            }))
                            .range([height, 0]);
                    }
                });

                svg.append("g")
                    .attr("class", "parcoords")
                    .selectAll("myPath")
                    .data(data)
                    .enter()
                    .append("path")
                    .attr("d", function (d) {
                        let line = d3.line();
                        return line(columns.map(function(p) {
                            return [xAxis(p), yAxis[p](d[p])];
                        }));
                    })
                    .attr("class", function(d) {
                        return "line " + d.Manufacturer + " " + d.Year;
                    })
                    .style("fill", "none" )
                    .style("stroke", function (d) {
                        return(color(d.Manufacturer))
                    })
                    .style("stroke-width", 1)
                    .style("opacity", 0.1)
                    .on("mouseover", function (d) {
                        console.log("Laps = " + d.Laps);
                        console.log("Ave Speed = " + d.AveSpeed);

                        // console.log(d);
                        // console.log(this);

                        if(lineClicked === false) {
                            d3.selectAll(".line")
                                .transition().duration(200)
                                .style("stroke", "lightgrey")
                                .style("opacity", 0.1);

                            d3.select(this)
                                .transition().duration(200)
                                .style("stroke", color(d.Manufacturer))
                                .style("opacity", 1)
                                .style("stroke-width", 2);
                        }
                    })
                    .on("mouseleave", function (d) {
                        if(lineClicked === false) {
                            document.getElementById("helper_text1").style.display = "none";
                            document.getElementById("helper_text2").style.display = "none";

                            d3.selectAll(".line")
                                .transition().duration(200).delay(500)
                                .style("stroke", function(e){
                                    // console.log(e);
                                    return(color(e.Manufacturer))
                                })
                                .style("opacity", 1)
                                .style("stroke-width", 1);
                        }
                    })
                    .on("click", function (d) {
                        console.log(d);
                        console.log(lineClicked);

                        lineClicked = !lineClicked;
                        setClickEvent(d)
                    });

                function setClickEvent(d) {
                    console.log(d);
                    console.log(lineClicked);

                    if(lineClicked === true) {
                        console.log("Year Clicked: "+d.Year);

                        let yearStr = d.Year;
                        let yearSubStr = yearStr.toString().substring(11, 15);
                        console.log(yearSubStr);

                        d3.select(this);
                        tooltip.transition()
                            .duration(100)
                            .style("opacity", 1)
                            .style("color", "coral");
                        tooltip.html(yearSubStr);

                        tooltip.html("<img src= winner_images/" + yearSubStr + ".jpg />");

                        let perc1 = (d.Laps/maxLaps)*100;
                        let perc2 = (d.AveSpeed/maxAveSpeed)*100;

                        createGauge(d, 'bar1', perc1, (d.Laps + " laps"));
                        createGauge(d, 'bar2', perc2, (d.AveSpeed + " kph"));

                        document.getElementById("helper_text1").style.display = "block";
                        document.getElementById("helper_text2").style.display = "block";
                    } else {
                        d3.selectAll(".line")
                            .transition().duration(200).delay(1000)
                            .style("stroke", function(e){
                                // console.log(e);
                                return(color(e.Manufacturer))
                            })
                            .style("opacity", 1)
                            .style("stroke-width", 1);

                        d3.select(".tooltip");
                        tooltip.html("");

                        d3.selectAll('.progress svg').remove();

                        document.getElementById("helper_text1").style.display = "none";
                        document.getElementById("helper_text2").style.display = "none";
                    }
                }

                function createGauge(d, divID, percent, textInsert) {
                    // console.log(d);
                    let wrapper = document.getElementById(divID);
                    let end = percent;
                    console.log("End = " + end + " Percent = " + percent);

                    let progress = 0;

                    var circle = d3.arc()
                        .startAngle(0)
                        .innerRadius(100)
                        .outerRadius(55);

                    var progSvg = d3.select(wrapper)
                        .append('svg')
                        .attr('class','progSvg')
                        .attr('width', 200)
                        .attr('height', 200)
                        .append('g')
                        .attr('transform', 'translate(' + 100 + ',' + 100 + ')');

                    var background = progSvg.append('g');
                    background.append('path')
                        .attr('class', 'tyre')
                        .attr('fill', 'black')
                        .style('fill-opacity', 0.75)
                        .attr('stroke', 'white')
                        .attr('stroke-width', '5px')
                        .attr('d', circle.endAngle(Math.PI * 2));

                    var foreground = background.append('path')
                        .attr('class', 'radial-path')
                        .attr('fill', color(d.Manufacturer))
                        .attr('stroke', 'white')
                        .attr('stroke-width', '5px');

                    var numberText = background.append('text')
                        .attr('class', 'radial-text')
                        .attr('text-anchor', 'middle');
                    numberText.text(textInsert);

                    // https://www.sitepoint.com/delay-sleep-pause-wait/
                    // https://codehandbook.org/understanding-settimeout-inside-for-loop-in-javascript/
                    (function iterate() {
                        foreground.attr('d', circle.endAngle(Math.PI * 2 * progress));
                        // https://github.com/d3/d3-format
                        if (end > 0) {
                            end--;
                            progress += 0.01;
                            setTimeout(iterate, 10);
                        }
                        console.log(progress);
                        console.log(end);

                    })();
                }

                let g = svg.selectAll(".col")
                    .data(columns)
                    .enter().append("g")
                    .attr("class", "col")
                    .attr("transform", function(d) {
                        return "translate(" + xAxis(d) + ")";
                    });

                g.append("g")
                    .attr("class", "axis")
                    .each(function(d) {
                        d3.select(this).call(d3.axisLeft(yAxis[d]));
                    })
                    .append("text")
                    .attr("text-anchor", "middle")
                    .attr("yAxis", -9)
                    .text(function(d) {
                        return d;
                    });

            });

        </script>

        <p id="picSource">Race car images courtesy of: https://www.motor1.com/news/252424/every-winner-24-hours-le-mans/</p>
    </body>
</html>
